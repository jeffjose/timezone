#!/usr/bin/env -S uv run --quiet --script
# /// script
# requires-python = ">=3.9"
# dependencies = [
#     "tzdata",
# ]
# ///

import sys
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo, available_timezones
from typing import List, Tuple
import os
import subprocess
import threading
import time
import select
import termios
import tty

def get_local_timezone():
    """Get the system's local timezone"""
    # Try to get the system timezone name
    try:
        # First try reading from /etc/localtime symlink
        result = subprocess.run(['timedatectl', 'show', '--property=Timezone', '--value'],
                              capture_output=True, text=True)
        if result.returncode == 0 and result.stdout.strip():
            return ZoneInfo(result.stdout.strip())
    except:
        pass

    try:
        # Try reading /etc/timezone
        with open('/etc/timezone', 'r') as f:
            tz_name = f.read().strip()
            if tz_name:
                return ZoneInfo(tz_name)
    except:
        pass

    try:
        # Try getting from environment
        tz_name = os.environ.get('TZ')
        if tz_name:
            return ZoneInfo(tz_name)
    except:
        pass

    # Last resort - use the local timezone from datetime
    # This gives us a timezone but not necessarily the correct name
    return datetime.now().astimezone().tzinfo

def get_local_city():
    """Get the local city name based on timezone"""
    # Map common timezones to city names
    timezone_to_city = {
        'America/Los_Angeles': 'SF',
        'America/New_York': 'NYC',
        'America/Chicago': 'CHI',
        'America/Denver': 'DEN',
        'America/Phoenix': 'PHX',
        'Europe/London': 'LON',
        'Europe/Paris': 'PAR',
        'Europe/Berlin': 'BER',
        'Asia/Tokyo': 'TYO',
        'Asia/Shanghai': 'SHA',
        'Asia/Kolkata': 'DEL',
        'Australia/Sydney': 'SYD',
    }

    try:
        # Get timezone string
        result = subprocess.run(['timedatectl', 'show', '--property=Timezone', '--value'],
                              capture_output=True, text=True)
        if result.returncode == 0 and result.stdout.strip():
            tz_name = result.stdout.strip()
            # Return city if in our map, otherwise extract last part of timezone
            if tz_name in timezone_to_city:
                return timezone_to_city[tz_name]
            else:
                # Extract city from timezone (e.g., America/Los_Angeles -> LA)
                city = tz_name.split('/')[-1].replace('_', ' ')
                # Take first 3 chars for label
                return city[:3].upper()
    except:
        pass

    return "LOC"  # Default local label

def get_hours_display(base_time: datetime, tz_name: str, tz: ZoneInfo, is_local: bool = False) -> Tuple[str, List[str]]:
    """Generate hours display for a timezone showing current time in that zone"""
    hours = []
    # Convert base_time to the target timezone to get current time there
    if isinstance(tz, ZoneInfo):
        current_time = base_time.astimezone(tz)
    else:
        # Handle case where tz might be a timezone.tzinfo object
        current_time = base_time.astimezone(tz)

    # Get the current hour in this timezone
    current_hour = current_time.hour

    # Start from midnight of current day in local timezone
    local_time = datetime.now().astimezone()
    start_time = local_time.replace(hour=0, minute=0, second=0, microsecond=0)

    for hour in range(24):
        # Calculate the time for this hour slot starting from our start_time
        time_slot = start_time + timedelta(hours=hour)
        # Convert to target timezone
        time_at_hour = time_slot.astimezone(tz)

        # Format the hour
        hour_12 = time_at_hour.hour % 12
        if hour_12 == 0:
            hour_12 = 12

        # Determine AM/PM and apply coloring
        if time_at_hour.hour < 6:  # Early morning (12am-5am)
            color = '\033[90m'  # Dark gray
        elif time_at_hour.hour < 12:  # Morning (6am-11am)
            color = '\033[93m'  # Yellow
        elif time_at_hour.hour < 18:  # Afternoon (12pm-5pm)
            color = '\033[92m'  # Green
        elif time_at_hour.hour < 21:  # Evening (6pm-8pm)
            color = '\033[94m'  # Blue
        else:  # Night (9pm-11pm)
            color = '\033[95m'  # Magenta

        reset = '\033[0m'

        # Add am/pm marker
        period = 'am' if time_at_hour.hour < 12 else 'pm'

        # Check if this is the current hour
        is_current_hour = (time_at_hour.hour == current_hour)

        # Format: "12am", "1am", etc.
        # Add box drawing character for current hour
        if is_current_hour:
            hour_str = f"{color}[{hour_12:2d}{period}]{reset}"
        else:
            hour_str = f"{color}{hour_12:2d}{period}{reset}"
        hours.append(hour_str)

    # Create label with star for local timezone
    if is_local:
        label = f"{tz_name}★:".ljust(5)
    else:
        label = f"{tz_name:4s}:"

    return label, hours

def display_timezones(timezones: List[Tuple[str, str]], debug=False):
    """Display timezone comparison grid"""
    # Get current time
    now = datetime.now(timezone.utc)

    if debug:
        print(f"DEBUG: UTC time: {now}")

    # Clear screen
    os.system('clear' if os.name != 'nt' else 'cls')

    # Color legend (no title)
    print()
    print("  \033[90m■\033[0m Night (12am-5am)  ", end="")
    print("\033[93m■\033[0m Morning (6am-11am)  ", end="")
    print("\033[92m■\033[0m Afternoon (12pm-5pm)  ", end="")
    print("\033[94m■\033[0m Evening (6pm-8pm)  ", end="")
    print("\033[95m■\033[0m Late (9pm-11pm)\033[0m")
    print()

    # Display each timezone
    for tz_label, tz_name in timezones:
        try:
            if tz_name == 'LOCAL':
                tz = get_local_timezone()
                # Get actual city name for local timezone
                city_label = get_local_city()
                is_local = True
                if debug:
                    print(f"DEBUG: Local TZ = {tz}, City = {city_label}")
            else:
                tz = ZoneInfo(tz_name)
                city_label = tz_label
                is_local = False
                if debug:
                    print(f"DEBUG: {tz_name} = {tz}")

            label, hours = get_hours_display(now, city_label, tz, is_local)

            # Print timezone row with day separator
            print(f"{label} ", end="")
            for i, hour in enumerate(hours):
                print(f"{hour:4s} ", end="")
                # Add separator after 11pm (at position 23) to show day boundary
                if i == 23:  # After 11pm, before what would be next midnight
                    print(" \033[90m|\033[0m", end="")
            print()

        except Exception as e:
            print(f"Error with timezone {tz_name}: {e}")

    print()

def show_help():
    """Display help menu"""
    print("\nCommands:")
    print("  a <timezone>  - Add a timezone (e.g., 'a America/New_York' or 'a NY America/New_York')")
    print("  r <label>     - Remove a timezone by label")
    print("  l             - List common timezones")
    print("  h             - Show this help")
    print("  q             - Quit")
    print()

def list_common_timezones():
    """List common timezones"""
    common_tzs = [
        "America/New_York (NY - Eastern Time)",
        "America/Chicago (CHI - Central Time)",
        "America/Denver (DEN - Mountain Time)",
        "America/Los_Angeles (LA - Pacific Time)",
        "Europe/London (LON - GMT/BST)",
        "Europe/Paris (PAR - Central European)",
        "Europe/Berlin (BER - Central European)",
        "Asia/Tokyo (TYO - Japan Time)",
        "Asia/Shanghai (SHA - China Time)",
        "Asia/Kolkata (DEL - India Time)",
        "Asia/Dubai (DXB - Gulf Time)",
        "Australia/Sydney (SYD - Australian Eastern)",
        "Pacific/Auckland (AKL - New Zealand)",
    ]
    print("\nCommon timezones:")
    for tz in common_tzs:
        print(f"  {tz}")
    print()

def get_input_nonblocking():
    """Get input without blocking"""
    old_settings = termios.tcgetattr(sys.stdin)
    try:
        tty.setraw(sys.stdin.fileno())
        if select.select([sys.stdin], [], [], 0) == ([sys.stdin], [], []):
            return sys.stdin.read(1)
    finally:
        termios.tcsetattr(sys.stdin, termios.TCSADRAIN, old_settings)
    return None

def main():
    import argparse
    parser = argparse.ArgumentParser(description='Timezone comparison tool')
    parser.add_argument('--interactive', '-i', action='store_true',
                       help='Run in interactive mode')
    parser.add_argument('--debug', '-d', action='store_true',
                       help='Enable debug output')
    args = parser.parse_args()

    # Default timezones to show
    timezones = [
        ("LOCAL", "LOCAL"),  # Will be replaced with actual city name
        ("LON", "Europe/London"),
    ]

    # Default: non-interactive mode - just display and exit
    if not args.interactive:
        display_timezones(timezones, debug=args.debug)
        return

    # Interactive mode
    # Keep track of whether we need to refresh
    refresh = True
    command_buffer = ""
    entering_command = False

    print("Timezone Overlap Tool")
    print("Press '?' for help, 'q' to quit")
    print()

    try:
        # Save terminal settings
        old_settings = termios.tcgetattr(sys.stdin)

        while True:
            if refresh and not entering_command:
                display_timezones(timezones)
                print("\nCommands: (a)dd, (r)emove, (l)ist, (h)elp, (q)uit")
                print("> ", end="", flush=True)
                refresh = False

            # Check for input
            tty.setraw(sys.stdin.fileno())
            if select.select([sys.stdin], [], [], 0.1) == ([sys.stdin], [], []):
                char = sys.stdin.read(1)
                termios.tcsetattr(sys.stdin, termios.TCSADRAIN, old_settings)

                if char == 'q':
                    print("\nExiting...")
                    break
                elif char == 'h' or char == '?':
                    show_help()
                    refresh = True
                elif char == 'l':
                    list_common_timezones()
                    refresh = True
                elif char == 'a':
                    print("\nAdd timezone (format: 'label timezone' or just 'timezone'): ", end="", flush=True)
                    cmd_input = input().strip()
                    if cmd_input:
                        parts = cmd_input.split()
                        if len(parts) == 2:
                            label, tz_name = parts
                            label = label[:4].upper()  # Limit label to 4 chars
                        elif len(parts) == 1:
                            tz_name = parts[0]
                            # Generate label from timezone name
                            label = tz_name.split('/')[-1][:3].upper()
                        else:
                            print("Invalid format")
                            time.sleep(1)
                            refresh = True
                            continue

                        try:
                            # Validate timezone
                            ZoneInfo(tz_name)
                            # Check if already exists
                            if any(l == label for l, _ in timezones):
                                print(f"Label {label} already exists")
                                time.sleep(1)
                            else:
                                timezones.append((label, tz_name))
                                print(f"Added {label}: {tz_name}")
                                time.sleep(0.5)
                        except Exception as e:
                            print(f"Invalid timezone: {tz_name}")
                            time.sleep(1)
                    refresh = True
                elif char == 'r':
                    print("\nRemove timezone (enter label): ", end="", flush=True)
                    label = input().strip().upper()
                    if label == "CURR":
                        print("Cannot remove current timezone")
                        time.sleep(1)
                    else:
                        original_len = len(timezones)
                        timezones[:] = [(l, tz) for l, tz in timezones if l != label]
                        if len(timezones) < original_len:
                            print(f"Removed {label}")
                        else:
                            print(f"Label {label} not found")
                        time.sleep(0.5)
                    refresh = True
                elif char == '\x03':  # Ctrl+C
                    raise KeyboardInterrupt
                else:
                    # Unknown command, just refresh
                    refresh = True
            else:
                termios.tcsetattr(sys.stdin, termios.TCSADRAIN, old_settings)

            # Auto-refresh every 60 seconds to update time
            time.sleep(0.1)

    except KeyboardInterrupt:
        print("\n\nExiting...")
    finally:
        # Restore terminal settings
        try:
            termios.tcsetattr(sys.stdin, termios.TCSADRAIN, old_settings)
        except:
            pass
        sys.exit(0)

if __name__ == "__main__":
    main()